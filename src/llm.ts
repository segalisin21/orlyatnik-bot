/**
 * LLM layer: Sales/Support (text) and Form (structured JSON). OpenAI Chat Completions.
 */

import OpenAI from 'openai';
import { env } from './config.js';
import { getKb } from './runtime-config.js';
import { logger } from './logger.js';
import type { Participant } from './sheets.js';

const openai = new OpenAI({ apiKey: env.OPENAI_API_KEY });

export type Intent = 'INFO' | 'BOOK' | 'UPDATE_FORM' | 'PAYMENT' | 'OTHER';

export interface FormPatch {
  fio?: string;
  city?: string;
  dob?: string;
  companions?: string;
  phone?: string;
  comment?: string;
  shift?: string;
}

export interface FormModeOutput {
  intent: Intent;
  reply_text: string;
  form_patch: FormPatch;
  next_status?: string;
  needs_confirmation?: boolean;
}

const FORM_JSON_INSTRUCTION = `–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º JSON-–æ–±—ä–µ–∫—Ç–æ–º –±–µ–∑ markdown –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –§–æ—Ä–º–∞—Ç:
{"intent":"INFO|BOOK|UPDATE_FORM|PAYMENT|OTHER","reply_text":"...","form_patch":{...},"needs_confirmation":true|false}
form_patch ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–ª—è, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (fio, city, dob, companions, phone, comment, shift).`;

function buildSalesSystem(event: string = 'orlyatnik'): string {
  const kb = getKb(event);
  if (event === 'pizhamnik') {
    return `–¢—ã ‚Äî –∂–∏–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤—ã–µ–∑–¥–∞ ¬´–ü–∏–∂–∞–º–Ω–∏–∫¬ª (21‚Äì22 –º–∞—Ä—Ç–∞, –¥–æ–º –∑–∞ –≥–æ—Ä–æ–¥–æ–º).
–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –ø–∞—Ñ–æ—Å–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.

üìå –§–∞–∫—Ç—ã

–î–∞—Ç—ã: 21‚Äì22 –º–∞—Ä—Ç–∞. –ó–∞–µ–∑–¥ 21 –º–∞—Ä—Ç–∞ –≤ 14:00, –≤—ã–µ–∑–¥ 22 –º–∞—Ä—Ç–∞ –≤ 14:00.
–°—Ç–æ–∏–º–æ—Å—Ç—å: ${kb.PRICE} ‚ÇΩ (–∑–∞–¥–∞—Ç–æ–∫ ${kb.DEPOSIT} ‚ÇΩ, –æ—Å—Ç–∞—Ç–æ–∫ ${(kb as { REMAINDER?: number }).REMAINDER ?? 4500} ‚ÇΩ ‚Äî –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 7 –¥–Ω–µ–π –¥–æ –Ω–∞—á–∞–ª–∞).
–ú–µ—Å—Ç: ${(kb as { PLACES_LIMIT?: number }).PLACES_LIMIT ?? 21}.
–í–æ–∑–≤—Ä–∞—Ç: ${(kb as { REFUND_DEADLINE_TEXT?: string }).REFUND_DEADLINE_TEXT ?? '–¥–æ 14 –º–∞—Ä—Ç–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç 4000 ‚ÇΩ.'}

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏ —É—Å–ª–æ–≤–∏—è: –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É ‚Äî –∫—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏ –∏–ª–∏ —Å–∫–∞–∂–∏ ¬´–Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Äû–£–∑–Ω–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É‚Äú –≤ –±–æ—Ç–µ¬ª. –£—Å–ª–æ–≤–∏—è –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–£—Å–ª–æ–≤–∏—è –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å¬ª.

–ü–æ–¥–≤–æ–¥–∏ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é: ¬´–ù–∞–∂–º–∏ ‚Äû–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ‚Äú –∏–ª–∏ –Ω–∞–ø–∏—à–∏ ‚Äû–•–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äú¬ª. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–æ—Ç —Å–æ–±–µ—Ä—ë—Ç –∞–Ω–∫–µ—Ç—É –∏ –¥–∞—Å—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –∑–∞–¥–∞—Ç–∫–∞.

–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è:
¬´–î–æ—Ä–æ–≥–æ¬ª ‚Üí ¬´${kb.OBJECTION_PRICE}¬ª
¬´–û–¥–∏–Ω/–æ–¥–Ω–∞¬ª ‚Üí ¬´${kb.OBJECTION_SOLO}¬ª
¬´–ù–µ –ø—å—é¬ª ‚Üí ¬´${kb.OBJECTION_NO_ALCOHOL}¬ª
¬´–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏¬ª ‚Üí ¬´${kb.OBJECTION_NO_COMPANY}¬ª

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —á–µ–∫ –≤ –±–æ—Ç–∞. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã. –°–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É.`;
  }
  return `–¢—ã ‚Äî –∂–∏–≤–æ–π –∏ –≤–∫–ª—é—á—ë–Ω–Ω—ã–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ª–∞–≥–µ—Ä—è –û—Ä–ª—è—Ç–Ω–∏–∫ 21+ üèï
–¢—ã –Ω–µ –±–æ—Ç, –∞ –±—É–¥—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä–æ–º—É —Å–∞–º–æ–º—É –∫–∞–π—Ñ–æ–≤–æ –æ—Ç —ç—Ç–æ–π –¥–≤–∏–∂—É—Ö–∏. –û—Ç–≤–µ—á–∞–π –ª–µ–≥–∫–æ, —Å —é–º–æ—Ä–æ–º, –Ω–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ. –°–ª–µ–¥–∏ –∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è, –µ—Å–ª–∏ —É–∂–µ —á—Ç–æ-—Ç–æ –æ–±—Å—É–¥–∏–ª–∏ (—Ç–µ–±–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

üìå –¢–≤–æ–∏ –∑–∞–¥–∞—á–∏

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ: –¥–∞—Ç—ã, —Ü–µ–Ω–∞, –ø—Ä–æ–≥—Ä–∞–º–º–∞, –º–µ—Å—Ç–æ, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç, —á—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π.

–ú—è–≥–∫–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–π –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è:

¬´–î–æ—Ä–æ–≥–æ¬ª ‚Üí ¬´${kb.OBJECTION_PRICE}¬ª

¬´–ë–æ—é—Å—å –µ—Ö–∞—Ç—å –æ–¥–∏–Ω/–æ–¥–Ω–∞¬ª ‚Üí ¬´${kb.OBJECTION_SOLO}¬ª

¬´–Ø –Ω–µ –ø—å—é / –Ω–µ —Ç—É—Å–æ–≤—ã–π¬ª ‚Üí ¬´${kb.OBJECTION_NO_ALCOHOL}¬ª

¬´–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏¬ª ‚Üí ¬´${kb.OBJECTION_NO_COMPANY}¬ª

¬´–ù–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—é, —Ä–∞—Å—Å–∫–∞–∂–∏¬ª ‚Üí –≤—Å–µ–≥–¥–∞ –≤—ã–¥–∞–≤–∞–π —è—Ä–∫–∏–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ä–∞—Å—Å–∫–∞–∑ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.

–ü–æ–¥–≤–æ–¥–∏ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é: –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –≥–æ—Ç–æ–≤ ‚Äî —Å–∫–∞–∂–∏: ¬´–ù–∞–ø–∏—à–∏ ¬´–•–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª –∏–ª–∏ ¬´–ì–æ—Ç–æ–≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª ‚Äî –∏ —è –Ω–∞—á–Ω—É —Å–±–æ—Ä –∞–Ω–∫–µ—Ç—ã¬ª. –í–∞–∂–Ω–æ: –±–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–∏–º —Ñ—Ä–∞–∑–∞–º.

–ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è –±–æ—Ç —Å–∞–º —Å–æ–±–µ—Ä—ë—Ç –∞–Ω–∫–µ—Ç—É (–§–ò–û, –≥–æ—Ä–æ–¥, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, —Å –∫–µ–º –µ–¥–µ—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏/–∞–ª–ª–µ—Ä–≥–∏–∏, —Å–º–µ–Ω–∞). –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —á—Ç–æ-—Ç–æ –º–µ–Ω—è–µ—Ç ‚Äî –≤—ã–≤–æ–¥–∏ –≤—Å—é –∞–Ω–∫–µ—Ç—É —Ü–µ–ª–∏–∫–æ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

–ü–æ—Å–ª–µ –∞–Ω–∫–µ—Ç—ã ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–¥–∞—Ç–æ–∫ ${kb.DEPOSIT} ‚ÇΩ –Ω–∞ –°–±–µ—Ä: ${kb.PAYMENT_SBER}

–í —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ–± –æ–ø–ª–∞—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—Å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∞–Ω–∫–µ—Ç—É + –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–º–µ–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Üí –ø–æ–∑–¥—Ä–∞–≤—å –∏ –ø–µ—Ä–µ–≤–µ–¥–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ —á–∞—Ç –∫ –ö—Ä–∏—Å—Ç–∏–Ω–µ (@${env.MANAGER_TG_USERNAME}). –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –æ–ø–ª–∞—Ç–∏–ª: –Ω–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç–µ ¬´–æ–ø–ª–∞—Ç–∏–ª¬ª –∏–ª–∏ ¬´–æ–ø–ª–∞—Ç–∏–ª–∞¬ª ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ!

–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∏—à—É—Ç—Å—è –≤ Google Sheets (–Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π username Telegram).

üîî –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ë–ª–∏–∂–∞–π—à–∞—è —Å–º–µ–Ω–∞: ${kb.NEXT_SHIFT_TEXT}. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞.

üìç –õ–æ–∫–∞—Ü–∏—è

${kb.LOCATION}

‚úÖ –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—á–∞—Å—Ç–∏—è –û—Ä–ª—è—Ç–Ω–∏–∫–∞ 21+:

üè† –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ —É—é—Ç–Ω—ã—Ö –∫–æ—Ä–ø—É—Å–∞—Ö —Å –æ—Ç–æ–ø–ª–µ–Ω–∏–µ–º
üçΩ –ü–æ–ª–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ (–∑–∞–≤—Ç—Ä–∞–∫–∏, –æ–±–µ–¥—ã, —É–∂–∏–Ω—ã)
üõÅ –ë–∞–Ω—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ
ü™© –í–µ—á–µ—Ä–∏–Ω–∫–∏ –∏ —Ä–µ–π–≤—ã —Å –¥–∏–¥–∂–µ—è–º–∏
üé≠ –ö–≤–µ—Å—Ç—ã, –∏–≥—Ä—ã, –∫–æ–Ω–∫—É—Ä—Å—ã –∏ speed dating
ü™ô –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ ¬´–æ—Ä–ª–∏–∫–∏¬ª –¥–ª—è –∑–∞–¥–∞–Ω–∏–π –∏ —Ñ–∞–Ω–∞ + –∞—É–∫—Ü–∏–æ–Ω
üì∏ –§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ —Å–æ —Å–º–µ–Ω—ã
ü§ù –ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –∫–æ–º–∞–Ω–¥–∞ ¬´—Å–≤–æ–∏—Ö¬ª

üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${kb.PRICE} ‚ÇΩ. –ó–∞–¥–∞—Ç–æ–∫: ${kb.DEPOSIT} ‚ÇΩ.

üéí –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π

${kb.WHAT_TO_TAKE}

üéØ –°—Ç–∏–ª—å

–õ—ë–≥–∫–∏–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, —Å —é–º–æ—Ä–æ–º. –û—Ç–≤–µ—á–∞–π —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–¥ –≤–∏–¥–µ—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –≤ –ª–∞–≥–µ—Ä–µ.

–ï—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–æ–º–Ω–µ–Ω–∏—è ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å–º–µ–Ω (—Å—Å—ã–ª–∫–∞: ${kb.MEDIA_CHANNEL}) –∏–ª–∏ –æ–±—â–µ–Ω–∏–µ —Å –ö—Ä–∏—Å—Ç–∏–Ω–æ–π (@${env.MANAGER_TG_USERNAME}). –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∫–µ–º-—Ç–æ ‚Äî –¥–∞–≤–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ –ö—Ä–∏—Å—Ç–∏–Ω—É.

–ù–∞ —Å–ª–æ–∂–Ω—ã–µ/–Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É) ‚Äî –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –ö—Ä–∏—Å—Ç–∏–Ω–µ.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –£ —Ç–µ–±—è –ù–ï–¢ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –∞–Ω–∫–µ—Ç—É —Å placeholder'–∞–º–∏ [–≤—Å—Ç–∞–≤—å —Å—é–¥–∞] –∏–ª–∏ –ø—É—Å—Ç—ã–º–∏ –ø–æ–ª—è–º–∏. –ê–Ω–∫–µ—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–æ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî —Ç—ã –µ—ë –Ω–µ –≤—ã–≤–æ–¥–∏—à—å. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç ¬´–æ–ø–ª–∞—Ç–∏–ª¬ª/¬´–æ–ø–ª–∞—Ç–∏–ª–∞¬ª ‚Äî –ù–ï –ø–æ–∑–¥—Ä–∞–≤–ª—è–π —Å –æ–ø–ª–∞—Ç–æ–π –∏ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π –∞–Ω–∫–µ—Ç—É. –û—Ç–≤–µ—Ç—å: ¬´–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É, –ø—Ä–∏—à–ª–∏ —á–µ–∫ (—Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç) —Å—é–¥–∞ –≤ –±–æ—Ç–∞ ‚Äî —Ç–æ–≥–¥–∞ —Å–º–æ–≥—É –ø—Ä–∏–Ω—è—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É¬ª.

‚ö†Ô∏è –í–∞–∂–Ω–æ: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—ã—à–µ ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—è–∑–∞—Ç—å —Å–≤–æ—ë –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç ¬´–≥–¥–µ-—Ç–æ –≤–∏–¥–µ–ª –ø–æ-–¥—Ä—É–≥–æ–º—É¬ª ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π –∫ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ª–∏–±–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –Ω–∞ –ö—Ä–∏—Å—Ç–∏–Ω—É. –ù–µ —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ø—Ä–æ–º–ø—Ç–µ. –í—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—è–π –¥–∞—Ç—ã, —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Å–∫–∏–¥–∫–∏ —Å —ç—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –∏–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–π –∫ –ö—Ä–∏—Å—Ç–∏–Ω–µ @${env.MANAGER_TG_USERNAME}.`;
}

/** Sales/Support: free-form text reply. */
export async function getSalesReply(userMessage: string, event: string = 'orlyatnik'): Promise<string> {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: buildSalesSystem(event) },
        { role: 'user', content: userMessage },
      ],
      temperature: 0.7,
      max_tokens: 800,
    });
    const text = completion.choices[0]?.message?.content?.trim();
    return text ?? `–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ö—Ä–∏—Å—Ç–∏–Ω–µ @${env.MANAGER_TG_USERNAME} ‚Äî –æ–Ω–∞ –ø–æ–¥—Å–∫–∞–∂–µ—Ç.`;
  } catch (e) {
    logger.error('OpenAI Sales error', { error: String(e) });
    return `–°–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–µ—Ä–µ–¥–∞–ª –≤–æ–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî –Ω–∞–ø–∏—à–∏ –ö—Ä–∏—Å—Ç–∏–Ω–µ @${env.MANAGER_TG_USERNAME}, –æ–Ω–∞ –æ—Ç–≤–µ—Ç–∏—Ç.`;
  }
}

const REVIVE_SYSTEM = `–¢—ã ‚Äî –∂–∏–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ª–∞–≥–µ—Ä—è –û—Ä–ª—è—Ç–Ω–∏–∫ 21+. –¢–µ–±–µ –¥–∞–ª–∏ –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –µ–≥–æ –æ–¥–Ω–∏–º –∫–æ—Ä–æ—Ç–∫–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º: —Å–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª –∏ —Ñ–∞–∫—Ç—ã, –Ω–æ —Å–¥–µ–ª–∞–π —Ç–æ–Ω —á—É—Ç—å –∂–∏–≤–µ–µ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–µ–µ, –∫–∞–∫ –±—É–¥—Ç–æ –ø–∏—à–µ—à—å —á–µ–ª–æ–≤–µ–∫—É –≤ —á–∞—Ç. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏ –Ω–µ –º–µ–Ω—è–π —Ü–∏—Ñ—Ä—ã/–¥–∞—Ç—ã. –û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;

/** Revive a stored answer: one LLM call to rephrase for a livelier tone. */
export async function reviveAnswer(storedAnswer: string): Promise<string> {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: REVIVE_SYSTEM },
        { role: 'user', content: storedAnswer },
      ],
      temperature: 0.6,
      max_tokens: 600,
    });
    const text = completion.choices[0]?.message?.content?.trim();
    return text ?? storedAnswer;
  } catch (e) {
    logger.error('OpenAI revive error', { error: String(e) });
    return storedAnswer;
  }
}

function formatAnketaForLlm(p: Participant): string {
  return [
    `fio: ${p.fio || ''}`,
    `city: ${p.city || ''}`,
    `dob: ${p.dob || ''}`,
    `companions: ${p.companions || ''}`,
    `phone: ${p.phone || ''}`,
    `comment: ${p.comment || ''}`,
    `shift: ${p.shift || ''}`,
  ].join(', ');
}

/** Form mode: structured output (intent + reply_text + form_patch). */
export async function getFormModeReply(
  userMessage: string,
  currentStatus: string,
  currentAnketa: Participant,
  event: string = 'orlyatnik'
): Promise<FormModeOutput> {
  const kb = getKb(event);
  const eventName = event === 'pizhamnik' ? '–ü–∏–∂–∞–º–Ω–∏–∫' : '–û—Ä–ª—è—Ç–Ω–∏–∫ 21+';
  const systemForm = `–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É —É—á–∞—Å—Ç–Ω–∏–∫–∞ ¬´${eventName}¬ª. –¢–æ–Ω: –∂–∏–≤–æ–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º ‚Äî –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞ (–ø—Ä–∏–≤–µ—Ç–ª–∏–≤–æ, —Å —ç–º–æ–¥–∑–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ).

–ü–æ–ª—è –∞–Ω–∫–µ—Ç—ã: fio, city, dob, companions, phone, comment, shift.
- –ò–∑–≤–ª–µ–∫–∞–π –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —É–∫–∞–∑–∞–ª.
- companions (—Å –∫–µ–º –µ–¥–µ—à—å): –ª—é–±–æ–µ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å ‚Äî ¬´–æ–¥–∏–Ω¬ª, ¬´–æ–¥–Ω–∞¬ª, ¬´–≤–¥–≤–æ—ë–º¬ª, ¬´–¥—É–º–∞—é¬ª, ¬´—Å–∞–º¬ª, ¬´—Å –ø–æ–¥—Ä—É–≥–æ–π¬ª, ¬´–ø–æ–∫–∞ –æ–¥–∏–Ω¬ª –∏ —Ç.–ø. ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–π –≤ form_patch.companions –∫–∞–∫ –µ—Å—Ç—å. –ù–µ –ø—Ä–æ—Å–∏ ¬´–Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ¬ª, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ —Å–º—ã—Å–ª—É –ø—Ä–æ —Ç–æ, —Å –∫–µ–º –µ–¥–µ—Ç (–≤ —Ç.—á. –æ–¥–∏–Ω/–æ–¥–Ω–∞/–¥—É–º–∞—é).
- shift: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å –¥–∞—Ç–∞–º–∏. –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–º–µ–Ω—ã: ¬´${kb.AVAILABLE_SHIFTS}¬ª. –°–º–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ¬´${kb.DEFAULT_SHIFT}¬ª. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª —Å–º–µ–Ω—É –∏–ª–∏ –Ω–∞–ø–∏—Å–∞–ª ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª ‚Äî –ø–æ–¥—Å—Ç–∞–≤—å –≤ form_patch shift: ¬´${kb.DEFAULT_SHIFT}¬ª.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–º–µ–Ω—è—Ç—å —Å–º–µ–Ω—É, –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫–∏–µ –¥–∞—Ç—ã¬ª / ¬´–∫–∞–∫–∏–µ —Å–º–µ–Ω—ã¬ª ‚Äî –≤ reply_text –ø–µ—Ä–µ—á–∏—Å–ª–∏ —Å–º–µ–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´${kb.AVAILABLE_SHIFTS}¬ª –∏ –ø–æ–ø—Ä–æ—Å–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω—É–∂–Ω—É—é –¥–∞—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–£ –Ω–∞—Å —Å–º–µ–Ω—ã: ${kb.AVAILABLE_SHIFTS}. –ù–∞–ø–∏—à–∏, –Ω–∞ –∫–∞–∫—É—é —Ö–æ—á–µ—à—å¬ª). –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ —Å–ø–∏—Å–∫–∞.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ—Ç–≤–µ—Ç –ø–∏—à–µ—Ç –¥–∞—Ç—É/–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´1 –º–∞—Ä—Ç–∞¬ª, ¬´25 —Ñ–µ–≤—Ä–∞–ª—è¬ª) ‚Äî –∏–∑–≤–ª–µ–∫–∏ —ç—Ç–æ –≤ form_patch.shift, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –æ–¥–Ω—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–º–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ (–ø–æ–¥—Å—Ç–∞–≤—å —Ç–æ—á–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–º–µ–Ω, –µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç).
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —á—Ç–æ-—Ç–æ –º–µ–Ω—è–µ—Ç ‚Äî –≤ reply_text –∫—Ä–∞—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏; –∫–æ–¥ –≤—ã–≤–µ–¥–µ—Ç –∞–Ω–∫–µ—Ç—É —Ü–µ–ª–∏–∫–æ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: intent, reply_text, form_patch, needs_confirmation (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
- intent: INFO | BOOK | UPDATE_FORM | PAYMENT | OTHER
- reply_text: —á—Ç–æ —Å–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∫–æ—Ä–æ—Ç–∫–æ, –≤ —Å—Ç–∏–ª–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞)
- form_patch: —Ç–æ–ª—å–∫–æ –ø–æ–ª—è, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–ª–∏ shift –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω)
- needs_confirmation: true –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∞–Ω–∫–µ—Ç—É —Ü–µ–ª–∏–∫–æ–º (¬´–¥–∞¬ª, ¬´–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é¬ª, ¬´–≤—Å—ë –≤–µ—Ä–Ω–æ¬ª)

–¢–µ–∫—É—â–∞—è –∞–Ω–∫–µ—Ç–∞: ${formatAnketaForLlm(currentAnketa)}
–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${currentStatus}`;

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemForm + '\n\n' + FORM_JSON_INSTRUCTION },
        { role: 'user', content: userMessage },
      ],
      response_format: { type: 'json_object' },
      temperature: 0.3,
      max_tokens: 500,
    });
    const raw = completion.choices[0]?.message?.content?.trim();
    if (!raw) {
      return {
        intent: 'OTHER',
        reply_text: `–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç. –ù–∞–ø–∏—à–∏ –ø–æ–ª–µ –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Å—å –∫ –ö—Ä–∏—Å—Ç–∏–Ω–µ @${env.MANAGER_TG_USERNAME}.`,
        form_patch: {},
      };
    }
    const parsed = JSON.parse(raw) as FormModeOutput;
    if (!parsed.reply_text) parsed.reply_text = '–ü—Ä–∏–Ω—è—Ç–æ. –ß—Ç–æ-—Ç–æ –µ—â—ë?';
    if (!parsed.form_patch) parsed.form_patch = {};
    return parsed;
  } catch (e) {
    logger.error('OpenAI Form error', { error: String(e) });
    return {
      intent: 'OTHER',
      reply_text: `–°–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –ö—Ä–∏—Å—Ç–∏–Ω–µ @${env.MANAGER_TG_USERNAME}.`,
      form_patch: {},
    };
  }
}
